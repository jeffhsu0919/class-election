<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç­ç´šå¹¹éƒ¨ç¥¨é¸ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase SDKï¼ˆcompat ç‰ˆï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF & html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f3f4f6;margin:0;padding:0;
    }
    .container{max-width:980px;margin:18px auto;padding:14px;}
    .card{
      background:#fff;border-radius:14px;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      padding:18px;
    }
    h1,h2,h3{margin:0 0 10px 0}
    button{border-radius:999px;padding:10px 18px;border:none;font-size:1rem;cursor:pointer}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-secondary{background:#16a34a;color:#fff}
    .btn-blue{background:#2563eb;color:#fff}
    .btn-green{background:#16a34a;color:#fff}
    .btn-red{background:#ef4444;color:#fff}
    .btn-gray{background:#6b7280;color:#fff}
    .hidden{display:none}

    /* å€™é¸äºº */
    .candidate-grid{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
      gap:10px;margin-top:10px;
    }
    .candidate-card{
      background:#f8fafc;border:1px solid #cbd5e1;
      padding:12px;border-radius:12px;text-align:center;position:relative;
    }
    .candidate-card.marked{
      border-color:#f59e0b;
      box-shadow:0 0 0 3px rgba(245,158,11,.25);
      background:#fffbeb;
    }
    .candidate-card .seat{font-size:1.05rem;font-weight:800;color:#0f172a}
    .candidate-card .name{margin-top:4px;font-size:1.05rem}
    .candidate-card .vote-count{
      font-size:1.35rem;color:#2563eb;font-weight:900;margin-top:8px;display:block
    }
    .cand-actions{
      display:flex;gap:8px;justify-content:center;margin-top:10px;
    }
    .cand-mini{
      border-radius:999px;padding:6px 12px;font-size:.9rem;
    }
    .cand-del{background:#ef4444;color:#fff}
    .cand-mark{background:#f59e0b;color:#111827}

    /* å­¸ç”ŸæŠ•ç¥¨æŒ‰éˆ• */
    .vote-buttons{
      display:grid;grid-template-columns:repeat(3,1fr);
      gap:12px;margin-top:14px;
    }
    .vote-btn{
      border-radius:18px;border:2px solid #2563eb;
      padding:16px 0;font-size:1.6rem;background:#fff;color:#2563eb;
      font-weight:800;
    }
    .vote-btn.selected{background:#2563eb;color:#fff}
    #student-status-bar{
      margin-top:10px;padding:10px;border-radius:10px;font-size:1rem;
    }

    /* å­¸ç”Ÿç«¯æ§åˆ¶å€æ›´ç°¡æ½”ã€æ›´å¤§é¡† */
    #student-actions{margin-top:14px;}
    #selected-info{text-align:center;font-size:1rem;color:#0f172a;margin-bottom:10px;font-weight:700}
    .student-action-btn{
      width:100%;
      padding:16px 0;
      font-size:1.25rem;
      border-radius:16px;
      font-weight:800;
    }
    .student-action-btn + .student-action-btn{margin-top:10px;}

    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:1rem}
    th,td{border:1px solid #d1d5db;padding:8px 10px;text-align:left}
    th{background:#e5e7eb}

    /* è€å¸«ç«¯ä½ˆå±€ */
    .section{
      background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin-bottom:14px;
    }
    .section-title{font-size:1.15rem;font-weight:900;margin-bottom:10px}
    .mode-title-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .mode-title-row select{
      flex:1;min-width:240px;padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;
      font-size:1rem;background:#fff;
    }
    .seat-input-row{display:flex;gap:10px;align-items:center;margin-top:6px}
    .seat-input{
      max-width:160px;padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;font-size:1rem;
    }
    .seat-grid-wrapper{margin-top:10px;max-height:160px;overflow-y:auto}
    .seat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(44px,1fr));gap:6px}
    .seat-btn{
      padding:8px 0;font-size:1rem;background:#fff !important;color:#0f172a !important;
      border:1px solid #cbd5e1;border-radius:10px;font-weight:800;
    }
    .seat-btn:active{transform:scale(.96)}

    .teacher-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .teacher-controls button{font-weight:800}

    .teacher-badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      background:#f1f5f9;
      color:#0f172a;
      margin-left:8px;
      font-size:.95rem;
    }
.teacher-badge strong{
  font-size: 1.35rem;
  padding: 2px 10px;
  border-radius: 999px;
  background: #0ea5e9;   /* è—ç¶ è‰²åº• */
  color: white;
  margin-left: 6px;
}

    
    @media (max-width: 640px){
      .container{padding:10px}
      button{font-size:1rem}
      .mode-title-row select{min-width:0}
    }
  </style>
</head>
<body>
<div class="container">
  <!-- è§’è‰²é¸æ“‡ -->
  <div class="card" id="role-selection">
    <h1 class="text-2xl font-bold mb-4">ğŸ—³ï¸ ç­ç´šå¹¹éƒ¨ç¥¨é¸</h1>
    <div class="flex flex-col gap-3">
      <button class="btn-primary" onclick="initTeacher()">æˆ‘æ˜¯è€å¸« (ç®¡ç†)</button>
      <button class="btn-secondary" onclick="initStudent()">æˆ‘æ˜¯å­¸ç”Ÿ (æŠ•ç¥¨)</button>
    </div>
  </div>

  <!-- å­¸ç”Ÿç•«é¢ -->
  <div class="card hidden" id="student-view">
    <h2 class="text-xl font-black">ğŸ“± å­¸ç”ŸæŠ•ç¥¨</h2>

    <div id="student-login" class="mt-3">
      <label class="font-bold">åº§è™Ÿ</label>
      <div class="flex gap-2 items-center mt-2">
        <input type="number" id="student-seat-input" placeholder="1~34" class="border rounded px-3 py-2" style="width:130px;">
        <button class="btn-primary" onclick="studentLogin()">ç™»å…¥</button>
      </div>
    </div>

    <div id="voting-area" class="hidden">
      <div id="student-status-bar" style="background:#fff7ed;">â˜• ç­‰å¾…è€å¸«ç™¼èµ·ä¸‹ä¸€è¼ª...</div>

      <div class="mt-2 text-sm text-slate-700">
        ä½ çš„åº§è™Ÿï¼š<span id="display-student-id" class="font-black"></span>
      </div>

      <div id="vote-options" class="vote-buttons hidden">
        <button class="vote-btn" onclick="castVote(1)">1</button>
        <button class="vote-btn" onclick="castVote(2)">2</button>
        <button class="vote-btn" onclick="castVote(3)">3</button>
        <button class="vote-btn" onclick="castVote(4)">4</button>
        <button class="vote-btn" onclick="castVote(5)">5</button>
        <button class="vote-btn" onclick="castVote(6)">6</button>
      </div>

      <div id="student-actions" class="hidden">
        <div id="selected-info">å·²é¸ï¼š0/1ä½</div>
        <button id="submit-vote-btn" class="btn-green student-action-btn" onclick="submitVote()">é€å‡ºæŠ•ç¥¨</button>
        <button id="clear-vote-btn" class="btn-gray student-action-btn" onclick="clearSelection()">æ¸…é™¤é¸æ“‡</button>
      </div>

      <div id="volunteer-area" class="hidden mt-3">
        <button class="btn-green" style="width:100%; padding:26px; font-size:1.45rem; font-weight:900; border-radius:18px;" onclick="volunteerMe()">âœ‹ æˆ‘è‡ªé¡˜æ“”ä»»</button>
      </div>
    </div>
  </div>

  <!-- è€å¸«ç•«é¢ -->
  <div id="teacher-view" class="hidden">
    <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
      <h2 class="text-2xl font-black">ğŸ‘¨â€ğŸ« è€å¸«ç®¡ç†å°</h2>
      <div>
        <span class="teacher-badge">å®ŒæˆæŠ•ç¥¨ç¸½äººæ•¸ï¼š<strong id="round-total-votes">0</strong></span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">1) è¨­å®šèˆ‡æå</div>

      <div class="mode-title-row">
        <select id="vote-mode" onchange="updateTitleOptions()">
          <option value="1">æ¨¡å¼ä¸€ï¼šæœ€é«˜ç¥¨ç•¶é¸ (1äºº)</option>
          <option value="2">æ¨¡å¼äºŒï¼šæ­£å‰¯å¹¹éƒ¨ (2äºº)</option>
          <option value="3">æ¨¡å¼ä¸‰ï¼šè‡ªé¡˜æ“”ä»» (ä¸é ˆæŠ•ç¥¨)</option>
        </select>
        <select id="officer-title"></select>
      </div>

      <div class="seat-grid-wrapper">
        <div id="seat-grid" class="seat-grid"></div>
      </div>

      <div id="candidate-list" class="candidate-grid"></div>
    </div>

    <div class="section">
      <div class="section-title">2) æŠ•ç¥¨æ§åˆ¶</div>
      <p id="teacher-status" style="margin-bottom:10px;font-weight:800;">âšª ç­‰å¾…é–‹å§‹</p>

      <div class="teacher-controls">
        <button class="btn-green" onclick="startVoting()">é–‹å§‹æŠ•ç¥¨ / é–‹æ”¾è‡ªé¡˜</button>
        <button class="btn-red" onclick="reVote()">é‡æ–°æŠ•ç¥¨</button>
        <button class="btn-gray" onclick="clearCandidates()">æ¸…é™¤ / ä¸‹ä¸€ä½</button>
        <button class="btn-blue" onclick="confirmElection()">âœ… ç¢ºèªç•¶é¸</button>
      </div>
    </div>

    <div class="card">
      <h3 class="text-xl font-black">ğŸ† ç•¶é¸åå–®</h3>
      <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
  <div>
    <label class="text-sm font-bold text-slate-700">ç­ç´šï¼ˆä¾‹ï¼š214ï¼‰</label>
    <input id="meta-class" class="border rounded px-3 py-2 w-full" placeholder="214" />
  </div>
  <div>
    <label class="text-sm font-bold text-slate-700">å­¸å¹´ï¼ˆä¾‹ï¼š114ï¼‰</label>
    <input id="meta-year" class="border rounded px-3 py-2 w-full" placeholder="114" />
  </div>
  <div>
    <label class="text-sm font-bold text-slate-700">å­¸æœŸï¼ˆä¾‹ï¼š1ï¼‰</label>
    <input id="meta-sem" class="border rounded px-3 py-2 w-full" placeholder="1" />
  </div>
</div>

<div id="pdf-title-preview" class="mt-2 text-slate-700 font-extrabold">
  ï¼ˆPDF æ¨™é¡Œé è¦½æœƒåœ¨ä¸‹è¼‰æ™‚ç”Ÿæˆï¼‰
</div>

      <div id="elected-table">
        <table>
          <thead>
            <tr>
              <th style="width:35%;">è·ä½</th>
              <th>åº§è™Ÿå§“å</th>
              <th style="width:90px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="elected-body"></tbody>
        </table>
      </div>
      <div class="flex flex-wrap gap-2 mt-3">
        <button class="btn-green" onclick="exportPDF()">ä¸‹è¼‰ PDF</button>
        <button class="btn-gray" onclick="clearElectedList()">æ¸…ç©ºç•¶é¸åå–®</button>
      </div>
      <p class="text-sm text-slate-600 mt-2">æç¤ºï¼šè‹¥èª¤æŒ‰ã€Œç¢ºèªç•¶é¸ã€ï¼Œå¯åœ¨è¡¨æ ¼å³å´åˆªé™¤å–®ç­†ã€‚</p>
    </div>
  </div>
</div>

<script>
  // ========== 1. Firebase è¨­å®š ==========
  const firebaseConfig = {
    apiKey: "AIzaSyBszNFqZSwar3bQdNuH7l4IBnZ-xA5gVus",
    authDomain: "class-vote-8dd3c.firebaseapp.com",
    databaseURL: "https://class-vote-8dd3c-default-rtdb.firebaseio.com",
    projectId: "class-vote-8dd3c",
    storageBucket: "class-vote-8dd3c.firebasestorage.app",
    messagingSenderId: "322166603892",
    appId: "1:322166603892:web:b0b8222d9dc08a8ac5d121",
    measurementId: "G-JWLTH9RDHN"
  };

  if (!firebaseConfig.apiKey) {
    alert("âš ï¸ è«‹å…ˆè¨­å®š Firebase Config");
  } else {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();

  // ========== 2. ç­ç´šå­¸ç”Ÿåå–® ==========
  const students = {
    "1": "é„­è‹¥å§","2":"å³ç‘‹åº­","3":"åŠ‰äºå®‰","4":"é¦¬å¦‚å›","5":"å¼µä½³ç‰",
    "6":"èƒ¡æ™ç‘‹","7":"è•­é›…è•™","8":"æ›¾ä½©è±","9":"å¼µæ†¶æ±","10":"ç¿å˜‰é¹",
    "11":"é¾æ²‚èŠ¯","12":"è©¹èŠ›æ·³","13":"æ›¾éˆ´æƒ ","14":"ä½™æ³“ç©","15":"æ­å¥•å»·",
    "16":"æ—æ³“å»·","17":"å¼µç‰æ‰¿","18":"ç°¡é¼æ©","19":"é™³æ°å®‰","20":"æ—é€¸æ˜Œ",
    "21":"å³å¾‹éŒ¡","22":"ç™½å®‡æ†","23":"è”¡ç±³å‚‘","24":"æ—å²‘è¬š","25":"è‘‰ç›Šè¯",
    "26":"ç‹æ˜±ä»","27":"é«˜ç¿Šå®¶","28":"é™³æ˜€æ”¿","29":"èŠç§‰é–","30":"å»–å®¶é´»",
    "31":"è¨±å®¶ç¿","32":"å¼µå³»æº","33":"æ›¾é¾æ°","34":"å‘¨å»¶å¡"
  };

  const MAX_SEAT_NO = 34;
  const titlesMode1 = ["ç­é•·","å‰¯ç­é•·","é¢¨ç´€è‚¡é•·","å‰¯é¢¨ç´€è‚¡é•·","è¡›ç”Ÿè‚¡é•·","å‰¯è¡›ç”Ÿè‚¡é•·","å­¸è—è‚¡é•·","å‰¯å­¸è—è‚¡é•·","ç’°ä¿è‚¡é•·","ç¸½å‹™è‚¡é•·","è¼”å°è‚¡é•·","åˆä½œæ•™è‚²è‚¡é•·","å…¬å‹™ã€åœ–æ›¸ã€è³‡è¨Šè‚¡é•·","é«”è‚²è‚¡é•·"];
  const titlesMode2 = ["ç­é•·èˆ‡å‰¯ç­é•·","é¢¨ç´€è‚¡é•·èˆ‡å‰¯é¢¨ç´€è‚¡é•·","è¡›ç”Ÿè‚¡é•·èˆ‡å‰¯è¡›ç”Ÿè‚¡é•·","å­¸è—è‚¡é•·èˆ‡å‰¯å­¸è—è‚¡é•·"];
  const titlesMode3 = titlesMode1;

  let mySeat = "";
  let currentCandidates = [];
  let electedList = [];
  let lastState = { isActive:false };
  let selectedCandidates = [];

  // ç”¨ä¾†åˆ¤æ–·ã€Œæ˜¯ä¸æ˜¯æ–°ä¸€è¼ªã€ï¼šä¿®å¾©å­¸ç”ŸæŒ‰éˆ• disabled æ²’å¾©åŸ
  let lastRoundId = null;

  // è€å¸«ç«¯æŠ•ç¥¨äººæ•¸ç›£è½
  let votersUnsub = null;

  // ========== å·¥å…·ï¼šæ¨¡å¼äºŒæ‹†è·ä½ ==========
  function splitMainViceTitle(title){
    // "é¢¨ç´€è‚¡é•·èˆ‡å‰¯é¢¨ç´€è‚¡é•·" => ["é¢¨ç´€è‚¡é•·","å‰¯é¢¨ç´€è‚¡é•·"]
    if (!title) return [title, title];
    const parts = title.split("èˆ‡");
    if (parts.length >= 2) return [parts[0], parts.slice(1).join("èˆ‡")];
    return [title, title];
  }

  // ========== 3. è€å¸«ç«¯ ==========
  function initTeacher(){
    document.getElementById('role-selection').classList.add('hidden');
    document.getElementById('teacher-view').classList.remove('hidden');
    updateTitleOptions();
    renderSeatGrid();

    db.ref('election/candidates').on('value', (snapshot) => {
      const data = snapshot.val() || [];
      // ç¢ºä¿æ¯ä½å€™é¸äººéƒ½æœ‰ marked æ¬„ä½
      currentCandidates = data.map(c => ({...c, marked: !!c.marked}));
      renderCandidatesTeacher();
    });
  }

  function updateTitleOptions(){
    const mode = document.getElementById('vote-mode').value;
    const sel = document.getElementById('officer-title');
    sel.innerHTML = "";
    let list = titlesMode1;
    if (mode === "2") list = titlesMode2;
    else if (mode === "3") list = titlesMode3;

    list.forEach(t=>{
      const opt=document.createElement('option');
      opt.value=t; opt.textContent=t;
      sel.appendChild(opt);
    });
  }

 function toggleMarkCandidate(index){
    if (!currentCandidates[index]) return;
    currentCandidates[index].marked = !currentCandidates[index].marked;
    db.ref('election/candidates').set(currentCandidates);
  }

  function deleteCandidate(index){
    if (!currentCandidates[index]) return;
    if (!confirm(`åˆªé™¤å€™é¸äººï¼š${currentCandidates[index].seat}è™Ÿ ${currentCandidates[index].name}ï¼Ÿ`)) return;
    currentCandidates.splice(index,1);
    db.ref('election/candidates').set(currentCandidates);
  }

  function renderCandidatesTeacher(){
    const div=document.getElementById('candidate-list');
    if(!div) return;
    div.innerHTML="";
    currentCandidates.forEach((c, idx)=>{
      const markedClass = c.marked ? "marked" : "";
      div.innerHTML += `
        <div class="candidate-card ${markedClass}">
          <div class="seat">${idx+1}. ${c.seat}è™Ÿ</div>
          <div class="name">${c.name}</div>
          <span class="vote-count">${c.votes} ç¥¨</span>
          <div class="cand-actions">
            <button class="cand-mini cand-mark" onclick="toggleMarkCandidate(${idx})">${c.marked ? "å–æ¶ˆæ¨™ç¤º" : "æ¨™ç¤º"}</button>
            <button class="cand-mini cand-del" onclick="deleteCandidate(${idx})">åˆªé™¤</button>
          </div>
        </div>`;
    });
  }

  function renderSeatGrid(){
    const grid=document.getElementById('seat-grid');
    if(!grid) return;
    grid.innerHTML="";
    for(let i=1;i<=MAX_SEAT_NO;i++){
      const btn=document.createElement('button');
      btn.className='seat-btn';
      btn.textContent=i;
      btn.onclick=()=> addCandidateBySeat(i);
      grid.appendChild(btn);
    }
  }

 function addCandidateBySeat(seat){
  const s = String(seat);

  if(!students[s]) return alert("æ²’æœ‰é€™å€‹åº§è™Ÿçš„å­¸ç”Ÿ");
  if(currentCandidates.length>=6) return alert("æœ€å¤šåªèƒ½ 6 ä½å€™é¸äºº");
  if(currentCandidates.some(c=> String(c.seat)===s)) return alert("é€™å€‹åº§è™Ÿå·²åœ¨å€™é¸äººåå–®ä¸­");

  const candidate={ seat: s, name: students[s], votes: 0, marked:false };
  currentCandidates.push(candidate);
  db.ref('election/candidates').set(currentCandidates);
}

  function startVoting(){
    const mode=document.getElementById('vote-mode').value;
    const title=document.getElementById('officer-title').value;
    if(!title) return alert("è«‹å…ˆé¸æ“‡å¹¹éƒ¨åç¨±");
    if(mode!=="3" && currentCandidates.length===0) return alert("è«‹å…ˆåŠ å…¥å€™é¸äºº");

    const state = {
      isActive:true,
      mode: mode,
      title: title,
      candidateCount: currentCandidates.length,
      timestamp: Date.now()
    };

    // 1) è¨­å®šç‹€æ…‹
    db.ref('election/state').set(state);
    // 2) æ¸…ç©ºæœ¬è¼ªæŠ•ç¥¨è€…æ¸…å–®(ç”¨ timestamp ç•¶ roundId)
    db.ref(`election/voters/${state.timestamp}`).set(null);
    // 3) æ¸…ç©ºæœ¬è¼ªè‡ªé¡˜è€…ï¼ˆä¿éšªï¼‰
    db.ref(`election/volunteers/${state.timestamp}`).set(null);

    document.getElementById('teacher-status').textContent="ğŸŸ¢ æŠ•ç¥¨é€²è¡Œä¸­";
    attachVotersCounter(state.timestamp);
  }

  function attachVotersCounter(roundId){
    // è§£é™¤èˆŠç›£è½
    if (votersUnsub) votersUnsub.off();
    const ref = db.ref(`election/voters/${roundId}`);
    votersUnsub = ref;
    ref.on('value', (snap)=>{
      const val = snap.val() || {};
      const count = Object.keys(val).length;
      document.getElementById('round-total-votes').textContent = count;
    });
  }

  function reVote(){
    if(!confirm("ç¢ºå®šé‡æ–°æŠ•ç¥¨ï¼Ÿç¥¨æ•¸å°‡æ­¸é›¶")) return;
    const resetList=currentCandidates.map(c=> ({...c, votes:0}));
    db.ref('election/candidates').set(resetList);
    startVoting();
  }

  function clearCandidates(){
    if(!confirm("ç¢ºå®šæ¸…é™¤å€™é¸äººä¸¦æº–å‚™ä¸‹ä¸€ä½å¹¹éƒ¨ï¼Ÿ")) return;

    currentCandidates=[];
    db.ref('election/candidates').set([]);
    db.ref('election/state').set({isActive:false});
    document.getElementById('teacher-status').textContent="âšª ç­‰å¾…é–‹å§‹";

    // æ¸…ç©ºç¥¨æ•¸é¡¯ç¤º
    document.getElementById('round-total-votes').textContent="0";

    // è§£é™¤ç¥¨æ•¸ç›£è½
    if (votersUnsub) votersUnsub.off();
    votersUnsub = null;

    renderCandidatesTeacher();
  }

  function confirmElection(){
    const mode=document.getElementById('vote-mode').value;
    const title=document.getElementById('officer-title').value;
    if(currentCandidates.length===0) return alert("æ²’æœ‰å€™é¸äºº");

    const sorted=[...currentCandidates].sort((a,b)=> (b.votes||0)-(a.votes||0));
    let winners=[];
    if(mode==="1") winners=sorted.slice(0,1);
    else if(mode==="2") winners=sorted.slice(0,2);
    else winners=sorted; // è‡ªé¡˜æ¨¡å¼ï¼šå…¨éƒ¨åˆ—å‡ºï¼ˆä½ ä¹Ÿå¯æ”¹æˆåªåˆ—ç¬¬ä¸€ä½æˆ–å…¨åˆ—ï¼‰

    if (mode==="2"){
      const [mainTitle, viceTitle] = splitMainViceTitle(title);
      if (winners[0]) electedList.push({title: mainTitle, seat:winners[0].seat, name:winners[0].name});
      if (winners[1]) electedList.push({title: viceTitle, seat:winners[1].seat, name:winners[1].name});
    } else {
      winners.forEach(w=>{
        electedList.push({title:title, seat:w.seat, name:w.name});
      });
    }

    renderElectedList();
  }

  function removeElected(index){
    if (!electedList[index]) return;
    if (!confirm(`åˆªé™¤ï¼š${electedList[index].title} / ${electedList[index].seat}è™Ÿ ${electedList[index].name}ï¼Ÿ`)) return;
    electedList.splice(index,1);
    renderElectedList();
  }

  function clearElectedList(){
    if (!confirm("ç¢ºå®šæ¸…ç©ºæ•´ä»½ç•¶é¸åå–®ï¼Ÿ")) return;
    electedList = [];
    renderElectedList();
  }

  function renderElectedList(){
    const tbody=document.getElementById('elected-body');
    tbody.innerHTML="";
    electedList.forEach((e, idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${e.title}</td>
        <td>${e.seat}è™Ÿ ${e.name}</td>
        <td>
          <button class="btn-red" style="padding:6px 12px;border-radius:12px;font-size:.95rem;font-weight:900" onclick="removeElected(${idx})">åˆªé™¤</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function exportPDF(){
    if(electedList.length===0) return alert("ç›®å‰æ²’æœ‰ç•¶é¸åå–®å¯åŒ¯å‡º");
    const tableEl=document.getElementById('elected-table');
  if(!tableEl) return alert("æ‰¾ä¸åˆ°ç•¶é¸åå–®å€å¡Š");

const classVal = (document.getElementById('meta-class')?.value || "").trim();
const yearVal  = (document.getElementById('meta-year')?.value || "").trim();
const semVal   = (document.getElementById('meta-sem')?.value || "").trim();

function classToText(v){
  if(!/^\d{3}$/.test(v)) return v ? `${v}ç­` : "";
  const g = v[0];
  const c = parseInt(v.slice(1), 10);
  return `${g}å¹´${c}ç­`;
}

const titleParts = [];
if(classVal) titleParts.push(classToText(classVal));
if(yearVal) titleParts.push(`${yearVal}å­¸å¹´`);
if(semVal)  titleParts.push(`ç¬¬${semVal}å­¸æœŸ`);
const pdfTitle = (titleParts.length ? `${titleParts.join(" ")} ` : "") + "ç­ç´šå¹¹éƒ¨ç•¶é¸åå–®";

// âœ… ç”¨ DOM çµ„åˆã€Œæ¨™é¡Œ + è¡¨æ ¼ã€å†æˆªåœ–ï¼Œé¿å…ä¸­æ–‡äº‚ç¢¼
const wrapper = document.createElement('div');
wrapper.style.background = '#fff';
wrapper.style.padding = '14px';
wrapper.style.width = tableEl.offsetWidth + 'px';

const titleDiv = document.createElement('div');
titleDiv.textContent = pdfTitle;
titleDiv.style.fontSize = '20px';
titleDiv.style.fontWeight = '900';
titleDiv.style.marginBottom = '10px';
titleDiv.style.color = '#0f172a';

const tableClone = tableEl.cloneNode(true);

wrapper.appendChild(titleDiv);
wrapper.appendChild(tableClone);

wrapper.style.position = 'fixed';
wrapper.style.left = '-99999px';
wrapper.style.top = '0';
document.body.appendChild(wrapper);

    // å®‰å…¨æ¸…ç†
    const cleanup = () => {
  if (wrapper && wrapper.parentNode) wrapper.parentNode.removeChild(wrapper);
};

html2canvas(wrapper, { scale: 2 }).then(canvas=>{
  ...
  cleanup();
}).catch(err=>{
  cleanup();
  alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼š" + err);
});

const { jsPDF } = window.jspdf;

html2canvas(wrapper, { scale: 2 }).then(canvas=>{
  const imgData=canvas.toDataURL('image/png');
  const pdf=new jsPDF('p','mm','a4');
  const pageWidth=pdf.internal.pageSize.getWidth();
  const margin=10;
  const imgWidth=pageWidth - margin*2;
  const ratio=imgWidth / canvas.width;
  const imgHeight=canvas.height * ratio;

  pdf.addImage(imgData,'PNG',margin,margin,imgWidth,imgHeight);
 pdf.save(`${pdfTitle}.pdf`);
cleanup();

}).catch(err=>{
 cleanup();
alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼š" + err);
});
  }

  // ========== 4. å­¸ç”Ÿç«¯ ==========
  function initStudent(){
    document.getElementById('role-selection').classList.add('hidden');
    document.getElementById('student-view').classList.remove('hidden');

    const stateRef=db.ref('election/state');

    stateRef.once('value').then(snap=>{
      const state=snap.val();
      syncStudentScreen(state);
    });

    stateRef.on('value',(snapshot)=>{
      const state=snapshot.val();
      syncStudentScreen(state);
    });
  }

  function studentLogin(){
    const input=document.getElementById('student-seat-input');
    const seat=input.value.trim();
    if(!seat) return alert("è«‹è¼¸å…¥åº§è™Ÿ");
    if(!students[seat]) return alert("æ²’æœ‰é€™å€‹åº§è™Ÿ");

    mySeat=seat;
    document.getElementById('student-login').classList.add('hidden');
    document.getElementById('voting-area').classList.remove('hidden');
    document.getElementById('display-student-id').innerText=mySeat;
  }

  function syncStudentScreen(state){
    const statusEl=document.getElementById('student-status-bar');
    const btnsEl=document.getElementById('vote-options');
    const volEl=document.getElementById('volunteer-area');
    const actionsEl=document.getElementById('student-actions');

    if(!state || state.isActive !== true){
      lastState={isActive:false};
      lastRoundId = null;
      statusEl.textContent="â˜• ç­‰å¾…è€å¸«ç™¼èµ·ä¸‹ä¸€è¼ª...";
      statusEl.style.background="#fff7ed";
      btnsEl.classList.add('hidden');
      volEl.classList.add('hidden');
      actionsEl.classList.add('hidden');
      resetStudentSelection();
      enableStudentActions(false);
      return;
    }

    // åˆ¤æ–·æ˜¯å¦æ–°ä¸€è¼ªï¼ˆtimestamp æ”¹äº†ï¼‰
    const roundId = state.timestamp || 'default';
    const isNewRound = (lastRoundId !== roundId);
    lastRoundId = roundId;
    lastState=state;

    if(state.mode==="3"){
      statusEl.textContent=`ğŸ™‹ å¾µæ±‚ï¼š${state.title}`;
      statusEl.style.background="#dcfce7";
      btnsEl.classList.add('hidden');
      volEl.classList.remove('hidden');
      actionsEl.classList.add('hidden');
      resetStudentSelection();
      enableStudentActions(false);
    } else {
      statusEl.textContent=`ğŸ—³ï¸ æ­£åœ¨ç¥¨é¸ï¼š${state.title}`;
      statusEl.style.background="#dbeafe";
      volEl.classList.add('hidden');
      btnsEl.classList.remove('hidden');
      actionsEl.classList.remove('hidden');

      // é¡¯ç¤º/å•Ÿç”¨å€™é¸äººæŒ‰éˆ•
      const max = state.candidateCount || 0;
      document.querySelectorAll('.vote-btn').forEach((btn, idx)=>{
        if(idx < max){
          btn.style.display='block';
          btn.disabled=false;
          btn.classList.remove('selected');
        } else {
          btn.style.display='none';
          btn.disabled=true;
          btn.classList.remove('selected');
        }
      });

      // âœ… é—œéµï¼šæ–°ä¸€è¼ªæˆ–æŠ•ç¥¨é€²è¡Œä¸­æ™‚ï¼Œå‹™å¿…æ¢å¾© submit/clear å¯ç”¨ï¼ˆä¿® bugï¼‰
      enableStudentActions(true);

      // æ–°ä¸€è¼ªæ‰å¼·åˆ¶æ¸…ç©ºé¸æ“‡ï¼ˆé¿å…è€å¸«åªæ›´æ–°ç¥¨æ•¸ç•«é¢æ™‚å­¸ç”Ÿé¸æ“‡è¢«æ¸…æ‰ï¼‰
      if (isNewRound) resetStudentSelection();
      updateSelectedInfo();
    }
  }

  function enableStudentActions(enabled){
    const submitBtn=document.getElementById('submit-vote-btn');
    const clearBtn=document.getElementById('clear-vote-btn');
    if (submitBtn) submitBtn.disabled = !enabled;
    if (clearBtn) clearBtn.disabled = !enabled;
  }

  function resetStudentSelection(){
    selectedCandidates=[];
    document.querySelectorAll('.vote-btn').forEach(btn=> btn.classList.remove('selected'));
    updateSelectedInfo();
  }

  function updateSelectedInfo(){
    const info=document.getElementById('selected-info');
    if(!info) return;
    const maxSelect = (!lastState || lastState.mode !== "2") ? 1 : 2;
    info.textContent=`å·²é¸ï¼š${selectedCandidates.length}/${maxSelect}ä½`;
  }

  function castVote(idx){
    if(!lastState || !lastState.isActive || lastState.mode==="3") return;

    const maxSelect = (lastState.mode==="2") ? 2 : 1;
    const alreadyIndex = selectedCandidates.indexOf(idx);
    const buttons = document.querySelectorAll('.vote-btn');
    const btn = buttons[idx-1];

    if(alreadyIndex >= 0){
      selectedCandidates.splice(alreadyIndex,1);
      btn.classList.remove('selected');
    } else {
      if(selectedCandidates.length >= maxSelect){
        alert(`æ­¤æ¨¡å¼æœ€å¤šå¯é¸ ${maxSelect} ä½å€™é¸äºº`);
        return;
      }
      selectedCandidates.push(idx);
      btn.classList.add('selected');
    }
    updateSelectedInfo();
  }

  function clearSelection(){
    if(!lastState || !lastState.isActive || lastState.mode==="3") return;
    resetStudentSelection();
  }

  function submitVote(){
    if(!lastState || !lastState.isActive || lastState.mode==="3"){
      alert("ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æŠ•ç¥¨");
      return;
    }
    if(selectedCandidates.length===0){
      alert("è«‹å…ˆé¸æ“‡å€™é¸äºº");
      return;
    }
    const seatKey = mySeat || document.getElementById('display-student-id').textContent;
    if(!seatKey){
      alert("è«‹å…ˆè¼¸å…¥åº§è™Ÿ");
      return;
    }

    const maxSelect = (lastState.mode==="2") ? 2 : 1;
    if(lastState.mode==="2" && selectedCandidates.length !== 2){
      alert("æ­£å‰¯å¹¹éƒ¨æ¨¡å¼éœ€é¸ 2 ä½å€™é¸äºº");
      return;
    }
    if(lastState.mode!=="2" && selectedCandidates.length !== 1){
      alert("æ­¤æ¨¡å¼éœ€é¸ 1 ä½å€™é¸äºº");
      return;
    }

    if(!confirm(`ç¢ºå®šé€å‡ºï¼Ÿä½ é¸äº† ${selectedCandidates.length}/${maxSelect} ä½å€™é¸äºº`)) return;

    const roundId = lastState.timestamp || 'default';
    const voterRef = db.ref(`election/voters/${roundId}/${seatKey}`);

    voterRef.once('value').then(snap=>{
      if(snap.exists()){
        alert("ä½ é€™ä¸€è¼ªå·²ç¶“æŠ•éç¥¨å›‰ï¼");
        return;
      }

      // å…ˆå¯«å…¥æŠ•ç¥¨è€…ï¼Œå†åŠ ç¥¨ï¼ˆé¿å…é‡è¤‡ï¼‰
      voterRef.set(true).then(()=>{
        selectedCandidates.forEach(idx=>{
          const candidateRef = db.ref(`election/candidates/${idx-1}/votes`);
          candidateRef.transaction(currentVotes => (currentVotes || 0) + 1);
        });

        // é€å‡ºå¾Œé–å®šæŒ‰éˆ•
        document.querySelectorAll('.vote-btn').forEach(b=> b.disabled=true);
        enableStudentActions(false);
        document.getElementById('student-status-bar').textContent="âœ… æŠ•ç¥¨æˆåŠŸï¼Œç­‰å¾…çµæœ";
        document.getElementById('student-status-bar').style.background="#dcfce7";
      });
    });
  }

  function volunteerMe(){
    if(!lastState || !lastState.isActive || lastState.mode!=="3"){
      alert("ç›®å‰ä¸æ˜¯è‡ªé¡˜æ“”ä»»æ¨¡å¼");
      return;
    }
    if(!confirm("ç¢ºå®šè‡ªé¡˜æ“”ä»»?")) return;

    const seatKey = mySeat || document.getElementById('display-student-id').textContent;
    if(!seatKey){
      alert("è«‹å…ˆè¼¸å…¥åº§è™Ÿ");
      return;
    }

    const roundId = lastState.timestamp || 'default';
    const volRef = db.ref(`election/volunteers/${roundId}/${seatKey}`);

    volRef.once('value').then(snap=>{
      if(snap.exists()){
        alert("ä½ å·²ç¶“ç™»è¨˜éå›‰ï¼");
        return;
      }
      volRef.set(true);

      db.ref('election/candidates').once('value').then(snap2=>{
        let list = snap2.val() || [];
        if(!list.some(c => String(c.seat)===String(seatKey))){
          list.push({ seat: seatKey, name: students[seatKey] || (seatKey+"è™Ÿ"), votes: 0, marked:false });
          db.ref('election/candidates').set(list);
        }
        alert("å·²é€å‡ºç”³è«‹ï¼");
      });
    });
  }

  // ä¾ç¶²å€è‡ªå‹•é€²å…¥è€å¸«/å­¸ç”Ÿç•«é¢
  window.addEventListener('load', ()=>{
    const hash = window.location.hash;
    if(hash === '#student') initStudent();
    else if(hash === '#teacher') initTeacher();
  });
</script>
</body>
</html>





