<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå¹¹éƒ¨ç¥¨é¸ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 20px; background: var(--bg); touch-action: manipulation; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #1e293b; }
        button { cursor: pointer; padding: 12px 18px; border-radius: 6px; border: none; font-weight: bold; font-size: 1rem; margin: 5px; color:white; }
        .btn-blue { background: var(--primary); }
        .btn-red { background: #dc2626; }
        .btn-green { background: #16a34a; }
        .btn-gray { background: #475569; }
        input, select { padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        .hidden { display: none !important; }
        .candidate-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px; }
        .candidate-card { background: #f8fafc; border: 1px solid #cbd5e1; padding: 10px; border-radius: 5px; text-align: center; }
        .vote-count { font-size: 1.5rem; color: var(--primary); font-weight: bold; display: block; margin-top: 5px; }
        
        .vote-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .vote-btn { padding: 30px 0; font-size: 2.5rem; background: white; border: 3px solid var(--primary); border-radius: 15px; color: var(--primary); }
        .vote-btn.selected { background: var(--primary); color: white; }
        .vote-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #999; color: #999; }
        
        #role-selection button { width: 100%; max-width: 300px; margin: 10px auto; display: block; padding: 20px; font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="container">
    <div id="role-selection">
        <h1>ğŸ—³ï¸ ç­ç´šå¹¹éƒ¨ç¥¨é¸</h1>
        <button class="btn-blue" onclick="initTeacher()">æˆ‘æ˜¯è€å¸« (ç®¡ç†)</button>
        <button class="btn-green" onclick="initStudent()">æˆ‘æ˜¯å­¸ç”Ÿ (æŠ•ç¥¨)</button>
    </div>

    <div id="teacher-view" class="hidden">
        <h2>ğŸ‘¨â€ğŸ« è€å¸«ç®¡ç†å°</h2>
        
        <div style="background:#eff6ff; padding:15px; border-radius:8px; margin-bottom:15px;">
            <h3>1. è¨­å®šèˆ‡æå</h3>
            <select id="vote-mode" onchange="updateTitleOptions()" style="margin-bottom:10px;">
                <option value="1">æ¨¡å¼ä¸€ï¼šæœ€é«˜ç¥¨ç•¶é¸ (1äºº)</option>
                <option value="2">æ¨¡å¼äºŒï¼šæ­£å‰¯å¹¹éƒ¨ (2äºº)</option>
                <option value="3">æ¨¡å¼ä¸‰ï¼šè‡ªé¡˜æ“”ä»» (ä¸é ˆæŠ•ç¥¨)</option>
            </select>
            <select id="officer-title" style="margin-bottom:10px;"></select>
            
            <div style="display:flex; gap:5px;">
                <input type="number" id="input-seat" placeholder="è¼¸å…¥åº§è™ŸåŠ å…¥" style="flex:1;">
                <button class="btn-blue" onclick="addCandidateLocal()">åŠ å…¥</button>
            </div>
            <div id="candidate-list" class="candidate-grid"></div>
        </div>

        <div style="background:#f0fdf4; padding:15px; border-radius:8px; margin-bottom:15px;">
            <h3>2. æŠ•ç¥¨æ§åˆ¶</h3>
            <div id="teacher-status" style="text-align:center; font-weight:bold; color:#d97706; margin-bottom:10px;">æº–å‚™ä¸­</div>
            <button class="btn-green" onclick="startVoting()">ğŸš€ é–‹å§‹æŠ•ç¥¨ / é–‹æ”¾è‡ªé¡˜</button>
            <button class="btn-red" onclick="reVote()">ğŸ”„ é‡æ–°æŠ•ç¥¨</button>
            <button class="btn-gray" onclick="clearCandidates()">ğŸ§¹ æ¸…é™¤ / ä¸‹ä¸€ä½</button>
            <hr>
            <button class="btn-blue" onclick="confirmElection()">âœ… ç¢ºèªç•¶é¸</button>
        </div>

        <div>
            <h3>ğŸ† ç•¶é¸åå–®</h3>
            <table id="elected-table" style="width:100%; border-collapse:collapse; margin-bottom:10px;">
                <tr style="background:#e2e8f0;"><th style="border:1px solid #cbd5e1; padding:5px;">è·ä½</th><th style="border:1px solid #cbd5e1; padding:5px;">åº§è™Ÿå§“å</th></tr>
            </table>
            <button class="btn-green" style="width:100%" onclick="exportPDF()">ä¸‹è¼‰ PDF</button>
        </div>
    </div>

    <div id="student-view" class="hidden">
        <h2>ğŸ“± å­¸ç”ŸæŠ•ç¥¨å€</h2>
        
        <div id="student-login">
            <label>è«‹è¼¸å…¥åº§è™Ÿï¼š</label>
            <input type="number" id="my-seat-num" style="font-size:1.5rem; text-align:center; margin:20px 0;">
            <button class="btn-blue" style="width:100%" onclick="studentLogin()">é€²å…¥ç³»çµ±</button>
        </div>

        <div id="voting-area" class="hidden">
            <div style="text-align:right; font-size:0.9rem; color:#64748b;">æˆ‘æ˜¯ï¼š<span id="display-student-id"></span>è™Ÿ</div>
            <div id="student-status-bar" style="background:#fff7ed; color:#9a3412; padding:15px; text-align:center; border-radius:8px; margin:15px 0; font-weight:bold;">
                ç­‰å¾…è€å¸«æŒ‡ä»¤...
            </div>
            
            <div id="vote-options" class="vote-buttons hidden">
                <button class="vote-btn" onclick="castVote(1)">1</button>
                <button class="vote-btn" onclick="castVote(2)">2</button>
                <button class="vote-btn" onclick="castVote(3)">3</button>
                <button class="vote-btn" onclick="castVote(4)">4</button>
                <button class="vote-btn" onclick="castVote(5)">5</button>
                <button class="vote-btn" onclick="castVote(6)">6</button>
            </div>
            
            <div id="volunteer-area" class="hidden">
                <button class="btn-green" style="width:100%; padding:30px; font-size:1.5rem;" onclick="volunteerMe()">âœ‹ æˆ‘è‡ªé¡˜æ“”ä»»</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. è¨­å®š Firebase
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyBszNFqZSwar3bQdNuH7l4IBnZ-xA5gVus",
        authDomain: "class-vote-8dd3c.firebaseapp.com",
        databaseURL: "https://class-vote-8dd3c-default-rtdb.firebaseio.com",
        projectId: "class-vote-8dd3c",
        storageBucket: "class-vote-8dd3c.firebasestorage.app",
        messagingSenderId: "322166603892",
        appId: "1:322166603892:web:b0b8222d9dc08a8ac5d121",
        measurementId: "G-JWLTH9RDHN"
    };

    // åˆå§‹åŒ– Firebase
    if (!firebaseConfig.apiKey) {
        alert("âš ï¸ è«‹å…ˆè¨­å®š Firebase Config");
    } else {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    
    // ==========================================
    // 2. ç³»çµ±é‚è¼¯
    // ==========================================

    const students = {
        1: "é„­è‹¥å§", 2: "å³ç‘‹åº­", 3: "åŠ‰äºå®‰", 4: "é¦¬å¦‚å›", 5: "å¼µä½³ç‰",
        6: "èƒ¡æ™ç‘‹", 7: "è•­é›…è•™", 8: "æ›¾ä½©è±", 9: "å¼µæ†¶æ±", 10: "ç¿å˜‰é¹",
        11: "é¾æ²‚èŠ¯", 12: "è©¹èŠ›æ·³", 13: "æ›¾éˆ´æƒ ", 14: "ä½™æ³“ç©", 15: "æ­å¥•å»·",
        16: "æ—æ³“å»·", 17: "å¼µç‰æ‰¿", 18: "ç°¡é¼æ©", 19: "é™³æ°å®‰", 20: "æ—é€¸æ˜Œ",
        21: "å³å¾‹éŒ¡", 22: "ç™½å®‡æ†", 23: "è”¡ç±³å‚‘", 24: "æ—å²‘è¬š", 25: "è‘‰ç›Šè¯",
        26: "ç‹æ˜±ä»", 27: "é«˜ç¿Šå®¶", 28: "é™³æ˜€æ”¿", 29: "èŠç§‰é–", 30: "å»–å®¶é´»",
        31: "è¨±å®¶ç¿", 32: "å¼µå³»æº", 33: "æ›¾é¾æ°", 34: "å‘¨å»¶å¡"
    };
    
    const titlesMode1 = ["ç­é•·", "å‰¯ç­é•·", "é¢¨ç´€è‚¡é•·", "å‰¯é¢¨ç´€è‚¡é•·", "è¡›ç”Ÿè‚¡é•·", "å‰¯è¡›ç”Ÿè‚¡é•·", "å­¸è—è‚¡é•·", "å‰¯å­¸è—è‚¡é•·", "ç’°ä¿è‚¡é•·", "ç¸½å‹™è‚¡é•·", "è¼”å°è‚¡é•·", "åˆä½œæ•™è‚²è‚¡é•·", "å…¬å‹™ã€åœ–æ›¸ã€è³‡è¨Šè‚¡é•·", "é«”è‚²è‚¡é•·"];
    const titlesMode2 = ["ç­é•·èˆ‡å‰¯ç­é•·", "é¢¨ç´€è‚¡é•·èˆ‡å‰¯é¢¨ç´€è‚¡é•·", "è¡›ç”Ÿè‚¡é•·èˆ‡å‰¯è¡›ç”Ÿè‚¡é•·", "å­¸è—è‚¡é•·èˆ‡å‰¯å­¸è—è‚¡é•·"];

    let mySeat = "";
    let currentCandidates = []; 
    let electedList = [];

    function initTeacher() {
        document.getElementById('role-selection').classList.add('hidden');
        document.getElementById('teacher-view').classList.remove('hidden');
        updateTitleOptions();
        
        db.ref('election/candidates').on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                currentCandidates = data;
                renderCandidatesTeacher();
            }
        });
    }

    function initStudent() {
        document.getElementById('role-selection').classList.add('hidden');
        document.getElementById('student-view').classList.remove('hidden');
        
        db.ref('election/state').on('value', (snapshot) => {
            const state = snapshot.val();
            if(state) syncStudentScreen(state);
        });
    }

    function updateTitleOptions() {
        const mode = document.getElementById('vote-mode').value;
        const select = document.getElementById('officer-title');
        select.innerHTML = "";
        let list = (mode === "2") ? titlesMode2 : titlesMode1;
        list.forEach(t => select.innerHTML += `<option value="${t}">${t}</option>`);
    }

    function addCandidateLocal() {
        const seatInput = document.getElementById('input-seat');
        const seat = seatInput.value;
        if(!students[seat]) return alert("ç„¡æ­¤åº§è™Ÿ");
        
        db.ref('election/candidates').once('value').then(snap => {
            let list = snap.val() || [];
            if(list.length >= 6) return alert("æœ€å¤š6äºº");
            
            list.push({ seat: seat, name: students[seat], votes: 0 });
            db.ref('election/candidates').set(list);
            seatInput.value = "";
        });
    }

    function renderCandidatesTeacher() {
        const div = document.getElementById('candidate-list');
        div.innerHTML = "";
        currentCandidates.forEach((c, idx) => {
            div.innerHTML += `
                <div class="candidate-card">
                    <div>${idx+1}. ${c.seat}è™Ÿ</div>
                    <div style="font-size:0.8rem">${c.name}</div>
                    <span class="vote-count">${c.votes} ç¥¨</span>
                </div>`;
        });
    }

    function startVoting() {
        const mode = document.getElementById('vote-mode').value;
        const title = document.getElementById('officer-title').value;
        
        db.ref('election/state').set({
            isActive: true,
            mode: mode,
            title: title,
            candidateCount: currentCandidates.length,
            timestamp: Date.now()
        });
        document.getElementById('teacher-status').textContent = "ğŸŸ¢ æŠ•ç¥¨é€²è¡Œä¸­";
    }

    function reVote() {
        if(!confirm("ç¢ºå®šé‡æ–°æŠ•ç¥¨ï¼Ÿç¥¨æ•¸å°‡æ­¸é›¶")) return;
        let resetList = currentCandidates.map(c => ({...c, votes: 0}));
        db.ref('election/candidates').set(resetList);
        startVoting();
    }

    function clearCandidates() {
        db.ref('election/candidates').set([]); 
        db.ref('election/state').set({ isActive: false }); 
        document.getElementById('teacher-status').textContent = "âšª ç­‰å¾…é–‹å§‹";
    }

    function confirmElection() {
        let sorted = [...currentCandidates].sort((a,b) => b.votes - a.votes);
        const mode = document.getElementById('vote-mode').value;
        const title = document.getElementById('officer-title').value;

        if(sorted.length === 0) return alert("ç„¡è³‡æ–™");

        if(mode === "1") {
            addElected(title, sorted[0]);
        } else if (mode === "2") {
            let titles = title.split("èˆ‡");
            if(sorted[0]) addElected(titles[0], sorted[0]);
            if(sorted[1]) addElected(titles[1], sorted[1]);
        } else {
             sorted.forEach(c => addElected(title + "(è‡ªé¡˜)", c));
        }
        
        clearCandidates();
        alert("å·²æ›´æ–°ç•¶é¸åå–®");
    }

    function addElected(title, student) {
        electedList.push({ title, seat: student.seat, name: student.name });
        const table = document.getElementById('elected-table');
        table.innerHTML += `<tr><td style="border:1px solid #ddd;padding:5px;">${title}</td><td style="border:1px solid #ddd;padding:5px;">${student.seat} ${student.name}</td></tr>`;
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Election Result", 10, 10);
        doc.autoTable({
            head: [['Title', 'Name']],
            body: electedList.map(e => [e.title, `${e.seat} ${e.name}`]),
        });
        doc.save('result.pdf');
    }

    function studentLogin() {
        mySeat = document.getElementById('my-seat-num').value;
        if(!mySeat) return alert("è«‹è¼¸å…¥åº§è™Ÿ");
        document.getElementById('student-login').classList.add('hidden');
        document.getElementById('voting-area').classList.remove('hidden');
        document.getElementById('display-student-id').innerText = mySeat;
    }

    function syncStudentScreen(state) {
        const statusEl = document.getElementById('student-status-bar');
        const btnsEl = document.getElementById('vote-options');
        const volEl = document.getElementById('volunteer-area');
        
        if(!state.isActive) {
            statusEl.textContent = "â˜• ç­‰å¾…è€å¸«ç™¼èµ·ä¸‹ä¸€è¼ª...";
            statusEl.style.background = "#fff7ed";
            btnsEl.classList.add('hidden');
            volEl.classList.add('hidden');
            return;
        }

        if(state.mode === "3") {
            statusEl.textContent = `ğŸ™‹ å¾µæ±‚ï¼š${state.title}`;
            statusEl.style.background = "#dcfce7";
            btnsEl.classList.add('hidden');
            volEl.classList.remove('hidden');
        } else {
            statusEl.textContent = `ğŸ—³ï¸ æ­£åœ¨ç¥¨é¸ï¼š${state.title}`;
            statusEl.style.background = "#dbeafe";
            volEl.classList.add('hidden');
            btnsEl.classList.remove('hidden');
            
            document.querySelectorAll('.vote-btn').forEach((btn, idx) => {
                btn.style.display = (idx < state.candidateCount) ? 'block' : 'none';
                btn.disabled = false;
                btn.classList.remove('selected');
            });
        }
    }

    function castVote(idx) {
        if(!confirm(`æŠ•çµ¦ ${idx} è™Ÿå€™é¸äºº?`)) return;
        
        const candidateRef = db.ref(`election/candidates/${idx-1}/votes`);
        candidateRef.transaction(currentVotes => (currentVotes || 0) + 1);

        document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true);
        document.querySelectorAll('.vote-btn')[idx-1].classList.add('selected');
        document.getElementById('student-status-bar').textContent = "âœ… æŠ•ç¥¨æˆåŠŸï¼Œç­‰å¾…çµæœ";
    }

    function volunteerMe() {
        if(!confirm("ç¢ºå®šè‡ªé¡˜æ“”ä»»?")) return;
        
        db.ref('election/candidates').once('value').then(snap => {
            let list = snap.val() || [];
            list.push({ seat: mySeat, name: students[mySeat], votes: 0 });
            db.ref('election/candidates').set(list);
            alert("å·²é€å‡ºç”³è«‹ï¼");
        });
    }
</script>
</body>
</html>
