<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ç­ç´šå¹¹éƒ¨ç¥¨é¸ç³»çµ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind via CDN (for basic utility classes, nonå¿…é ˆä½†ä¿ç•™ä»¥ä¾¿æ’ç‰ˆ) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF èˆ‡ AutoTable & html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 960px;
            margin: 20px auto;
            padding: 15px;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
            padding: 20px;
        }
        h1, h2, h3 {
            margin: 0 0 10px 0;
        }
        button {
            border-radius: 999px;
            padding: 10px 18px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        .btn-secondary {
            background: #16a34a;
            color: white;
        }
        .btn-blue { background:#2563eb; color:white; }
        .btn-green { background:#16a34a; color:white; }
        .btn-red { background:#ef4444; color:white; }
        .btn-gray { background:#6b7280; color:white; }
        .hidden { display:none; }
        .candidate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .candidate-card { 
            background: #f8fafc; 
            border: 1px solid #cbd5e1; 
            padding: 12px; 
            border-radius: 10px; 
            text-align: center; 
        }
        .candidate-card .seat { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #0f172a; 
        }
        .candidate-card .name { 
            margin-top: 4px; 
            font-size: 1.05rem; 
        }
        .candidate-card .vote-count { 
            font-size: 1.4rem; 
            color: #2563eb; 
            font-weight: bold; 
            margin-top: 8px; 
            display: block; 
        }
        .vote-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        .vote-btn {
            border-radius: 16px;
            border: 2px solid #2563eb;
            padding: 18px 0;
            font-size: 1.6rem;
            background: white;
            color: #2563eb;
        }
        .vote-btn.selected {
            background: #2563eb;
            color: white;
        }
        #student-status-bar {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.95rem;
        }
        th, td {
            border: 1px solid #d1d5db;
            padding: 6px 8px;
            text-align: left;
        }
        th {
            background: #e5e7eb;
        }

        /* è€å¸«ç«¯ä½ˆå±€å„ªåŒ– */
        .mode-title-row { 
            display:flex; 
            gap:8px; 
            flex-wrap:wrap; 
            margin-bottom:8px; 
        }
        .mode-title-row select { 
            flex:1; 
            min-width:0; 
        }
        .seat-input-row { 
            display:flex; 
            gap:8px; 
            align-items:center; 
            margin-top:4px; 
        }
        .seat-input { 
            max-width:140px; 
        }
        .seat-grid-wrapper { 
            margin-top:8px; 
            max-height:140px; 
            overflow-y:auto; 
        }
        .seat-grid { 
            display:grid; 
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); 
            gap:4px; 
        }
        .seat-btn { 
            padding:6px 0; 
            font-size:0.9rem; 
            background:#ffffff !important; 
            color:#0f172a !important; 
            border:1px solid #cbd5e1; 
            border-radius:6px; 
        }
        .seat-btn:active { 
            transform:scale(0.96); 
        }

        /* å­¸ç”Ÿç«¯æ–°æ§åˆ¶å€ */
        #student-actions { 
            margin-top:12px; 
        }
        #selected-info { 
            text-align:center; 
            font-size:0.95rem; 
            color:#0f172a; 
            margin-bottom:6px; 
        }

        @media (max-width: 640px) {
            .container {
                padding: 10px;
            }
            button {
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card" id="role-selection">
        <h1 class="text-2xl font-bold mb-4">ğŸ—³ï¸ ç­ç´šå¹¹éƒ¨ç¥¨é¸</h1>
        <div class="flex flex-col gap-3">
            <button class="btn-primary" onclick="initTeacher()">æˆ‘æ˜¯è€å¸« (ç®¡ç†)</button>
            <button class="btn-secondary" onclick="initStudent()">æˆ‘æ˜¯å­¸ç”Ÿ (æŠ•ç¥¨)</button>
        </div>
    </div>

    <!-- å­¸ç”Ÿç•«é¢ -->
    <div class="card hidden" id="student-view">
        <h2>ğŸ“± å­¸ç”ŸæŠ•ç¥¨å€</h2>
        
        <div id="student-login">
            <label>æˆ‘çš„åº§è™Ÿï¼š</label>
            <input type="number" id="student-seat-input" placeholder="è¼¸å…¥åº§è™Ÿ" class="border rounded px-2 py-1" style="width:120px;">
            <button class="btn-primary" onclick="studentLogin()">ç™»å…¥</button>
        </div>

        <div id="voting-area" class="hidden">
            <div id="student-status-bar" style="background:#fff7ed;">â˜• ç­‰å¾…è€å¸«ç™¼èµ·ä¸‹ä¸€è¼ª...</div>
            <p style="margin-top:8px;">æˆ‘æ˜¯ï¼š<span id="display-student-id"></span>è™Ÿ</p>

            <div id="vote-options" class="vote-buttons hidden">
                <button class="vote-btn" onclick="castVote(1)">1</button>
                <button class="vote-btn" onclick="castVote(2)">2</button>
                <button class="vote-btn" onclick="castVote(3)">3</button>
                <button class="vote-btn" onclick="castVote(4)">4</button>
                <button class="vote-btn" onclick="castVote(5)">5</button>
                <button class="vote-btn" onclick="castVote(6)">6</button>
            </div>

            <div id="student-actions" class="hidden">
                <div id="selected-info">å·²é¸ï¼š0/1ä½</div>
                <button id="submit-vote-btn" class="btn-green" style="width:100%; margin-bottom:6px;" onclick="submitVote()">é€å‡ºæŠ•ç¥¨</button>
                <button id="clear-vote-btn" class="btn-gray" style="width:100%;" onclick="clearSelection()">æ¸…é™¤é¸æ“‡</button>
            </div>
            
            <div id="volunteer-area" class="hidden">
                <button class="btn-green" style="width:100%; padding:30px; font-size:1.5rem;" onclick="volunteerMe()">âœ‹ æˆ‘è‡ªé¡˜æ“”ä»»</button>
            </div>
        </div>
    </div>

    <!-- è€å¸«ç•«é¢ -->
    <div id="teacher-view" class="hidden">
        <h2>ğŸ‘¨â€ğŸ« è€å¸«ç®¡ç†å°</h2>
        
        <div style="background:#eff6ff; padding:15px; border-radius:8px; margin-bottom:15px;">
            <h3>1. è¨­å®šèˆ‡æå</h3>
            <div class="mode-title-row">
                <select id="vote-mode" onchange="updateTitleOptions()">
                    <option value="1">æ¨¡å¼ä¸€ï¼šæœ€é«˜ç¥¨ç•¶é¸ (1äºº)</option>
                    <option value="2">æ¨¡å¼äºŒï¼šæ­£å‰¯å¹¹éƒ¨ (2äºº)</option>
                    <option value="3">æ¨¡å¼ä¸‰ï¼šè‡ªé¡˜æ“”ä»» (ä¸é ˆæŠ•ç¥¨)</option>
                </select>
                <select id="officer-title"></select>
            </div>

            <div class="seat-input-row">
                <input type="number" id="input-seat" placeholder="è¼¸å…¥åº§è™ŸåŠ å…¥" class="seat-input">
                <button class="btn-blue" onclick="addCandidateLocal()">åŠ å…¥</button>
            </div>

            <div class="seat-grid-wrapper">
                <div id="seat-grid" class="seat-grid"></div>
            </div>

            <div id="candidate-list" class="candidate-grid"></div>
        </div>

        <div style="background:#f0fdf4; padding:15px; border-radius:8px; margin-bottom:15px;">
            <h3>2. æŠ•ç¥¨æ§åˆ¶</h3>
            <p id="teacher-status" style="margin-bottom:10px;">âšª ç­‰å¾…é–‹å§‹</p>
            <div class="flex flex-wrap gap-2 mb-3">
                <button class="btn-green" onclick="startVoting()">é–‹å§‹æŠ•ç¥¨ / é–‹æ”¾è‡ªé¡˜</button>
                <button class="btn-red" onclick="reVote()">é‡æ–°æŠ•ç¥¨</button>
                <button class="btn-gray" onclick="clearCandidates()">æ¸…é™¤ / ä¸‹ä¸€ä½</button>
            </div>
            <button class="btn-blue" onclick="confirmElection()">âœ… ç¢ºèªç•¶é¸</button>
        </div>

        <div class="card">
            <h3>ğŸ† ç•¶é¸åå–®</h3>
            <div id="elected-table">
                <table>
                    <thead>
                        <tr>
                            <th>è·ä½</th>
                            <th>åº§è™Ÿå§“å</th>
                        </tr>
                    </thead>
                    <tbody id="elected-body"></tbody>
                </table>
            </div>
            <button class="btn-green mt-3" onclick="exportPDF()">ä¸‹è¼‰ PDF</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. è¨­å®š Firebase
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyBszNFqZSwar3bQdNuH7l4IBnZ-xA5gVus",
        authDomain: "class-vote-8dd3c.firebaseapp.com",
        databaseURL: "https://class-vote-8dd3c-default-rtdb.firebaseio.com",
        projectId: "class-vote-8dd3c",
        storageBucket: "class-vote-8dd3c.firebasestorage.app",
        messagingSenderId: "322166603892",
        appId: "1:322166603892:web:b0b8222d9dc08a8ac5d121",
        measurementId: "G-JWLTH9RDHN"
    };

    // åˆå§‹åŒ– Firebase
    if (!firebaseConfig.apiKey) {
        alert("âš ï¸ è«‹å…ˆè¨­å®š Firebase Config");
    } else {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // ==========================================
    // 2. å­¸ç”Ÿåå–®ï¼ˆåº§è™Ÿ -> å§“åï¼‰
    // ==========================================
    const students = {
        "1": "é„­è‹¥å§", "2": "å³ç‘‹åº­", "3": "åŠ‰äºå®‰", "4": "é¦¬å¦‚å›", "5": "å¼µä½³ç‰",
        "6": "èƒ¡æ™ç‘‹", "7": "è•­é›…è•™", "8": "æ›¾ä½©è±", "9": "å¼µæ†¶æ±", "10": "ç¿å˜‰é¹",
        "11": "é¾æ²‚èŠ¯", "12": "è©¹èŠ›æ·³", "13": "æ›¾éˆ´æƒ ", "14": "ä½™æ³“ç©", "15": "æ­å¥•å»·",
        "16": "æ—æ³“å»·", "17": "å¼µç‰æ‰¿", "18": "ç°¡é¼æ©", "19": "é™³æ°å®‰", "20": "æ—é€¸æ˜Œ",
        "21": "å³å¾‹éŒ¡", "22": "ç™½å®‡æ†", "23": "è”¡ç±³å‚‘", "24": "æ—å²‘è¬š", "25": "è‘‰ç›Šè¯",
        "26": "ç‹æ˜±ä»", "27": "é«˜ç¿Šå®¶", "28": "é™³æ˜€æ”¿", "29": "èŠç§‰é–", "30": "å»–å®¶é´»",
        "31": "è¨±å®¶ç¿", "32": "å¼µå³»æº", "33": "æ›¾é¾æ°", "34": "å‘¨å»¶å¡"
    };

    const MAX_SEAT_NO = 34; // ç­ç´šæœ€å¤§åº§è™Ÿï¼Œå¯ä¾éœ€è¦ä¿®æ”¹
    const titlesMode1 = ["ç­é•·", "å‰¯ç­é•·", "é¢¨ç´€è‚¡é•·", "å‰¯é¢¨ç´€è‚¡é•·", "è¡›ç”Ÿè‚¡é•·", "å‰¯è¡›ç”Ÿè‚¡é•·", "å­¸è—è‚¡é•·", "å‰¯å­¸è—è‚¡é•·", "ç’°ä¿è‚¡é•·", "ç¸½å‹™è‚¡é•·", "è¼”å°è‚¡é•·", "åˆä½œæ•™è‚²è‚¡é•·", "å…¬å‹™ã€åœ–æ›¸ã€è³‡è¨Šè‚¡é•·", "é«”è‚²è‚¡é•·"];
    const titlesMode2 = ["ç­é•·èˆ‡å‰¯ç­é•·", "é¢¨ç´€è‚¡é•·èˆ‡å‰¯é¢¨ç´€è‚¡é•·", "è¡›ç”Ÿè‚¡é•·èˆ‡å‰¯è¡›ç”Ÿè‚¡é•·", "å­¸è—è‚¡é•·èˆ‡å‰¯å­¸è—è‚¡é•·"];
    const titlesMode3 = titlesMode1; // è‡ªé¡˜æ¨¡å¼ç”¨åŒä¸€ä»½å¹¹éƒ¨æ¸…å–®

    let mySeat = "";
    let currentCandidates = []; 
    let electedList = [];

    // ==========================================
    // 3. è€å¸«ç«¯
    // ==========================================
    function initTeacher() {
        document.getElementById('role-selection').classList.add('hidden');
        document.getElementById('teacher-view').classList.remove('hidden');
        updateTitleOptions();
        renderSeatGrid();
        
        db.ref('election/candidates').on('value', (snapshot) => {
            const data = snapshot.val() || [];
            currentCandidates = data;
            renderCandidatesTeacher();
        });
    }

    function updateTitleOptions() {
        const mode = document.getElementById('vote-mode').value;
        const sel = document.getElementById('officer-title');
        sel.innerHTML = "";
        let list = titlesMode1;
        if (mode === "2") list = titlesMode2;
        else if (mode === "3") list = titlesMode3;

        list.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            sel.appendChild(opt);
        });
    }

    function addCandidateLocal() {
        const seatInput = document.getElementById('input-seat');
        const seat = seatInput.value.trim();
        if(!seat) return alert("è«‹è¼¸å…¥åº§è™Ÿ");
        if(!students[seat]) return alert("æ²’æœ‰é€™å€‹åº§è™Ÿçš„å­¸ç”Ÿ");

        if(currentCandidates.length >= 6) {
            alert("æœ€å¤šåªèƒ½ 6 ä½å€™é¸äºº");
            return;
        }
        if(currentCandidates.some(c => c.seat == seat)) {
            alert("é€™å€‹åº§è™Ÿå·²åœ¨å€™é¸äººåå–®ä¸­");
            return;
        }

        const candidate = { seat: seat, name: students[seat], votes: 0 };
        currentCandidates.push(candidate);
        db.ref('election/candidates').set(currentCandidates);
        seatInput.value = "";
    }

    function renderCandidatesTeacher() {
        const div = document.getElementById('candidate-list');
        if(!div) return;
        div.innerHTML = "";
        currentCandidates.forEach((c, idx) => {
            div.innerHTML += `
                <div class="candidate-card">
                    <div class="seat">${idx + 1}. ${c.seat}è™Ÿ</div>
                    <div class="name">${c.name}</div>
                    <div class="vote-count">${c.votes} ç¥¨</div>
                </div>`;
        });
    }

    function renderSeatGrid() {
        const grid = document.getElementById('seat-grid');
        if(!grid) return;
        grid.innerHTML = "";
        for(let i = 1; i <= MAX_SEAT_NO; i++) {
            const btn = document.createElement('button');
            btn.className = 'seat-btn';
            btn.textContent = i;
            btn.onclick = () => addCandidateBySeat(i);
            grid.appendChild(btn);
        }
    }

    function addCandidateBySeat(seat) {
        const seatInput = document.getElementById('input-seat');
        seatInput.value = seat;
        addCandidateLocal();
    }

    function startVoting() {
        const mode = document.getElementById('vote-mode').value;
        const title = document.getElementById('officer-title').value;
        if(!title) return alert("è«‹å…ˆé¸æ“‡å¹¹éƒ¨åç¨±");
        if(mode !== "3" && currentCandidates.length === 0) {
            return alert("è«‹å…ˆåŠ å…¥å€™é¸äºº");
        }

        const roundId = Date.now();

        db.ref('election/state').set({
            isActive: true,
            mode: mode,
            title: title,
            candidateCount: currentCandidates.length,
            timestamp: roundId
        });

        db.ref(`election/voters/${roundId}`).set(null);

        document.getElementById('teacher-status').textContent = "ğŸŸ¢ æŠ•ç¥¨é€²è¡Œä¸­";
    }

    function reVote() {
        if(!confirm("ç¢ºå®šé‡æ–°æŠ•ç¥¨ï¼Ÿç¥¨æ•¸å°‡æ­¸é›¶")) return;
        let resetList = currentCandidates.map(c => ({...c, votes: 0}));
        db.ref('election/candidates').set(resetList);
        startVoting();
    }

    function clearCandidates() {
        if(!confirm("ç¢ºå®šæ¸…é™¤å€™é¸äººä¸¦æº–å‚™ä¸‹ä¸€ä½å¹¹éƒ¨ï¼Ÿ")) return;
        currentCandidates = [];
        db.ref('election/candidates').set([]);
        db.ref('election/state').set({ isActive: false });
        document.getElementById('teacher-status').textContent = "âšª ç­‰å¾…é–‹å§‹";
    }

    function confirmElection() {
        const mode = document.getElementById('vote-mode').value;
        const title = document.getElementById('officer-title').value;
        if (currentCandidates.length === 0) {
            alert("æ²’æœ‰å€™é¸äºº");
            return;
        }
        let sorted = [...currentCandidates].sort((a,b)=> b.votes - a.votes);
        let winners = [];
        if (mode === "1") {
            winners = sorted.slice(0,1);
        } else if (mode === "2") {
            winners = sorted.slice(0,2);
        } else {
            winners = sorted;
        }

        winners.forEach(w => {
            electedList.push({
                title: title,
                seat: w.seat,
                name: w.name
            });
        });
        renderElectedList();
    }

    function renderElectedList() {
        const tbody = document.getElementById('elected-body');
        tbody.innerHTML = "";
        electedList.forEach(e => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${e.title}</td><td>${e.seat}è™Ÿ ${e.name}</td>`;
            tbody.appendChild(tr);
        });
    }

    function exportPDF() {
        if(electedList.length === 0) {
            alert("ç›®å‰æ²’æœ‰ç•¶é¸åå–®å¯åŒ¯å‡º");
            return;
        }
        const tableEl = document.getElementById('elected-table');
        if(!tableEl) {
            alert("æ‰¾ä¸åˆ°ç•¶é¸åå–®å€å¡Š");
            return;
        }

        const { jsPDF } = window.jspdf;
        html2canvas(tableEl).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 10;
            const imgWidth = pageWidth - margin * 2;
            const ratio = imgWidth / canvas.width;
            const imgHeight = canvas.height * ratio;

            pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
            pdf.save('ç•¶é¸åå–®.pdf');
        });
    }

    // ==========================================
    // 4. å­¸ç”Ÿç«¯
    // ==========================================
    function initStudent() {
        document.getElementById('role-selection').classList.add('hidden');
        document.getElementById('student-view').classList.remove('hidden');
        
        db.ref('election/state').on('value', (snapshot) => {
            const state = snapshot.val();
            if(state) syncStudentScreen(state);
        });
    }

    function studentLogin() {
        const input = document.getElementById('student-seat-input');
        const seat = input.value.trim();
        if(!seat) return alert("è«‹è¼¸å…¥åº§è™Ÿ");
        if(!students[seat]) return alert("æ²’æœ‰é€™å€‹åº§è™Ÿ");

        mySeat = seat;
        document.getElementById('student-login').classList.add('hidden');
        document.getElementById('voting-area').classList.remove('hidden');
        document.getElementById('display-student-id').innerText = mySeat;
    }

    let selectedCandidates = [];
    let lastState = null;

    function syncStudentScreen(state) {
        lastState = state;
        const statusEl = document.getElementById('student-status-bar');
        const btnsEl = document.getElementById('vote-options');
        const volEl = document.getElementById('volunteer-area');
        const actionsEl = document.getElementById('student-actions');

        if(!state || !state.isActive) {
            statusEl.textContent = "â˜• ç­‰å¾…è€å¸«ç™¼èµ·ä¸‹ä¸€è¼ª...";
            statusEl.style.background = "#fff7ed";
            btnsEl.classList.add('hidden');
            volEl.classList.add('hidden');
            if(actionsEl) actionsEl.classList.add('hidden');
            resetStudentSelection();
            return;
        }

        if(state.mode === "3") {
            statusEl.textContent = `ğŸ™‹ å¾µæ±‚ï¼š${state.title}`;
            statusEl.style.background = "#dcfce7";
            btnsEl.classList.add('hidden');
            volEl.classList.remove('hidden');
            if(actionsEl) actionsEl.classList.add('hidden');
            resetStudentSelection();
        } else {
            statusEl.textContent = `ğŸ—³ï¸ æ­£åœ¨ç¥¨é¸ï¼š${state.title}`;
            statusEl.style.background = "#dbeafe";
            volEl.classList.add('hidden');
            btnsEl.classList.remove('hidden');
            if(actionsEl) actionsEl.classList.remove('hidden');

            const max = state.candidateCount || 0;
            document.querySelectorAll('.vote-btn').forEach((btn, idx) => {
                btn.style.display = (idx < max) ? 'block' : 'none';
                btn.disabled = false;
                btn.classList.remove('selected');
            });
            document.getElementById('submit-vote-btn').disabled = false;
            document.getElementById('clear-vote-btn').disabled = false;
            resetStudentSelection();
            updateSelectedInfo();
        }
    }

    function resetStudentSelection() {
        selectedCandidates = [];
        document.querySelectorAll('.vote-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        updateSelectedInfo();
    }

    function updateSelectedInfo() {
        const info = document.getElementById('selected-info');
        if(!info) return;
        const maxSelect = (!lastState || lastState.mode !== "2") ? 1 : 2;
        info.textContent = `å·²é¸ï¼š${selectedCandidates.length}/${maxSelect}ä½`;
    }

    function castVote(idx) {
        if(!lastState || !lastState.isActive || lastState.mode === "3") return;

        const maxSelect = (lastState.mode === "2") ? 2 : 1;
        const alreadyIndex = selectedCandidates.indexOf(idx);
        const buttons = document.querySelectorAll('.vote-btn');
        const btn = buttons[idx - 1];

        if(alreadyIndex >= 0) {
            selectedCandidates.splice(alreadyIndex, 1);
            btn.classList.remove('selected');
        } else {
            if(selectedCandidates.length >= maxSelect) {
                alert(`æ­¤æ¨¡å¼æœ€å¤šå¯é¸ ${maxSelect} ä½å€™é¸äºº`);
                return;
            }
            selectedCandidates.push(idx);
            btn.classList.add('selected');
        }
        updateSelectedInfo();
    }

    function clearSelection() {
        if(!lastState || !lastState.isActive || lastState.mode === "3") return;
        resetStudentSelection();
    }

    function submitVote() {
        if(!lastState || !lastState.isActive || lastState.mode === "3") {
            alert("ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æŠ•ç¥¨");
            return;
        }
        if(selectedCandidates.length === 0) {
            alert("è«‹å…ˆé¸æ“‡å€™é¸äºº");
            return;
        }

        const seatKey = mySeat || document.getElementById('display-student-id').textContent;
        if(!seatKey) {
            alert("è«‹å…ˆè¼¸å…¥åº§è™Ÿ");
            return;
        }

        const maxSelect = (lastState.mode === "2") ? 2 : 1;
        if(!confirm(`ç¢ºå®šé€å‡ºï¼Ÿä½ é¸äº† ${selectedCandidates.length}/${maxSelect} ä½å€™é¸äºº`)) {
            return;
        }

        const roundId = lastState.timestamp || 'default';
        const voterRef = db.ref(`election/voters/${roundId}/${seatKey}`);

        voterRef.once('value').then(snap => {
            if(snap.exists()) {
                alert("ä½ é€™ä¸€è¼ªå·²ç¶“æŠ•éç¥¨å›‰ï¼");
                return;
            }
            voterRef.set(true);

            selectedCandidates.forEach(idx => {
                const candidateRef = db.ref(`election/candidates/${idx - 1}/votes`);
                candidateRef.transaction(currentVotes => (currentVotes || 0) + 1);
            });

            document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true);
            document.getElementById('submit-vote-btn').disabled = true;
            document.getElementById('clear-vote-btn').disabled = true;
            document.getElementById('student-status-bar').textContent = "âœ… æŠ•ç¥¨æˆåŠŸï¼Œç­‰å¾…çµæœ";
        });
    }

    function volunteerMe() {
        if(!lastState || !lastState.isActive || lastState.mode !== "3") {
            alert("ç›®å‰ä¸æ˜¯è‡ªé¡˜æ“”ä»»æ¨¡å¼");
            return;
        }
        if(!confirm("ç¢ºå®šè‡ªé¡˜æ“”ä»»?")) return;

        const seatKey = mySeat || document.getElementById('display-student-id').textContent;
        if(!seatKey) {
            alert("è«‹å…ˆè¼¸å…¥åº§è™Ÿ");
            return;
        }

        const roundId = lastState.timestamp || 'default';
        const volRef = db.ref(`election/volunteers/${roundId}/${seatKey}`);

        volRef.once('value').then(snap => {
            if(snap.exists()) {
                alert("ä½ å·²ç¶“ç™»è¨˜éå›‰ï¼");
                return;
            }
            volRef.set(true);

            db.ref('election/candidates').once('value').then(snap2 => {
                let list = snap2.val() || [];
                if(!list.some(c => String(c.seat) === String(seatKey))) {
                    list.push({ seat: seatKey, name: students[seatKey] || (seatKey + "è™Ÿ"), votes: 0 });
                    db.ref('election/candidates').set(list);
                }
                alert("å·²é€å‡ºç”³è«‹ï¼");
            });
        });
    }

    // ä¾ç¶²å€è‡ªå‹•é€²å…¥è€å¸«/å­¸ç”Ÿç•«é¢
    // ä¾‹å¦‚å­¸ç”Ÿç”¨é€£çµï¼š .../class-election/#student
    // è€å¸«ç”¨é€£çµï¼š .../class-election/ æˆ– .../class-election/#teacher
    window.addEventListener('load', () => {
        const hash = window.location.hash;
        if(hash === '#student') {
            initStudent();
        } else if(hash === '#teacher') {
            initTeacher();
        }
    });
</script>
</body>
</html>




